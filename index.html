<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>American Spirit Interactive Magazine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* Prevents double-tap zoom on mobile */
        }
        .magazine-page {
            transition: transform 0.5s ease-in-out, box-shadow 0.5s ease-in-out;
            transform-style: preserve-3d;
        }
        /* Styles for the modal */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <!-- The aspect ratio of this container has been updated to match your image -->
    <div class="w-full max-w-6xl aspect-[1632/1056]" id="magazine-container">
        <!-- Switched to CSS Grid to eliminate the gap between pages -->
        <div class="w-full h-full grid grid-cols-2 rounded-lg shadow-lg">
            <img id="left-page-img" src="" alt="Left Magazine Page" class="w-full h-full object-contain rounded-l-lg bg-white">
            <img id="right-page-img" src="" alt="Right Magazine Page" class="w-full h-full object-contain rounded-r-lg bg-white">
        </div>
    </div>

    <!-- Unified Controls Container -->
    <div class="mt-8 flex justify-center items-center flex-wrap gap-4">
        <!-- Previous Button -->
        <button id="prev-btn" class="px-4 py-3 md:px-6 bg-white text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
            Previous
        </button>
        <!-- Page Indicator -->
        <div id="page-indicator" class="text-gray-600 font-medium text-sm text-center w-32">
            <!-- This will be updated by JS -->
        </div>
        <!-- Next Button -->
        <button id="next-btn" class="px-4 py-3 md:px-6 bg-white text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
            Next
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
        </button>
        <!-- Gemini AI Feature Button -->
        <button id="ai-ask-btn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all flex items-center">
            âœ¨ Ask about this page
        </button>
    </div>

    <!-- Publication Info -->
    <div class="mt-4 text-center text-black text-sm">
        American Spirit | September/October 2025
    </div>

    <!-- Gemini AI Modal -->
    <div id="ai-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-2xl rounded-lg shadow-xl p-6 transform -translate-y-10">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Ask about this page</h2>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="flex justify-center space-x-4">
                    <button id="summarize-btn" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 border border-gray-300">Summarize this page</button>
                    <button id="more-btn" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 border border-gray-300">Tell me more</button>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="text" id="ai-prompt-input" class="flex-grow border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Ask about a specific topic...">
                    <button id="ai-submit-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-blue-300">Ask</button>
                </div>
                <div id="ai-response-container" class="mt-4 p-4 bg-gray-50 rounded-lg min-h-[100px] max-h-[300px] overflow-y-auto">
                    <div id="ai-loader" class="hidden justify-center items-center h-full">
                        <div class="loader"></div>
                    </div>
                    <div id="ai-response-text" class="text-gray-700 whitespace-pre-wrap"></div>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const pageImages = [
                'https://i.postimg.cc/wMssCdZb/1.jpg', 
                'https://i.postimg.cc/grF6dTPc/2.jpg',
                'https://i.postimg.cc/zDLtzH14/3.jpg', 
                'https://i.postimg.cc/GhGXY0tQ/4.jpg',
                'https://i.postimg.cc/P5H2Q68k/5.jpg', 
                'https://i.postimg.cc/RZTGsccJ/6.jpg',
                'https://i.postimg.cc/PqryBP43/7.jpg', 
                'https://i.postimg.cc/C194BJVX/8.jpg'
            ];
            
            const spreadPageNumbers = [
                'Pages 28 & 29',
                'Pages 30 & 31',
                'Pages 32 & 33',
                'Pages 14 & 15'
            ];
            // --- END CONFIGURATION ---

            const leftPageImg = document.getElementById('left-page-img');
            const rightPageImg = document.getElementById('right-page-img');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const pageIndicator = document.getElementById('page-indicator');
            const aiAskBtn = document.getElementById('ai-ask-btn');
            const aiModal = document.getElementById('ai-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const aiPromptInput = document.getElementById('ai-prompt-input');
            const aiSubmitBtn = document.getElementById('ai-submit-btn');
            const aiResponseContainer = document.getElementById('ai-response-container');
            const aiLoader = document.getElementById('ai-loader');
            const aiResponseText = document.getElementById('ai-response-text');
            const summarizeBtn = document.getElementById('summarize-btn');
            const moreBtn = document.getElementById('more-btn');

            const totalSpreads = pageImages.length / 2;
            let currentSpread = 0;

            function updateButtons() {
                prevBtn.disabled = currentSpread === 0;
                nextBtn.disabled = currentSpread >= totalSpreads - 1;
            }

            function updatePageIndicator() {
                pageIndicator.textContent = spreadPageNumbers[currentSpread] || `Spread ${currentSpread + 1}`;
            }

            function displaySpread() {
                const leftPageIndex = currentSpread * 2;
                const rightPageIndex = currentSpread * 2 + 1;
                
                leftPageImg.src = pageImages[leftPageIndex];
                rightPageImg.src = pageImages[rightPageIndex];
                
                updatePageIndicator();
                updateButtons();
            }

            async function getBase64(imageUrl) {
                 const imageResponse = await fetch(imageUrl);
                 if (!imageResponse.ok) {
                    throw new Error(`HTTP error! status: ${imageResponse.status}`);
                 }
                 const imageBlob = await imageResponse.blob();
                 return new Promise((resolve, reject) => {
                     const reader = new FileReader();
                     reader.onloadend = () => resolve({base64: reader.result.split(',')[1], mimeType: imageBlob.type});
                     reader.onerror = reject;
                     reader.readAsDataURL(imageBlob);
                 });
            }
            
            async function getAnswer(prompt, imageUrl) {
                aiLoader.style.display = 'flex';
                const lowerCasePrompt = prompt.toLowerCase();

                // Set the initial text based on the prompt
                if (lowerCasePrompt.includes('summarize')) {
                    aiResponseText.innerHTML = '<b>Summary:</b><br><br>';
                } else if (lowerCasePrompt.includes('tell me more')) {
                    aiResponseText.innerHTML = '<b>More Information:</b><br><br>';
                } else {
                    aiResponseText.innerHTML = `<b>${prompt}</b><br><br>`;
                }

                aiSubmitBtn.disabled = true;
                summarizeBtn.disabled = true;
                moreBtn.disabled = true;
                
                try {
                    const imageData = await getBase64(imageUrl);
                    let finalPrompt;

                    if (lowerCasePrompt.includes('summarize')) {
                        finalPrompt = `You are an expert magazine guide. The user wants a summary of the attached magazine page. 
                        Please provide a concise summary that is **strictly no more than 250 words**. The summary's length should also be proportional to the amount of text on the page (a short article gets a short summary).
                        Synthesize the information on the page with your own broad knowledge. Do not just repeat the text from the page.
                        Important: Do not start your response with phrases like "The magazine page provides a fascinating overview". Get straight to the point.
                        Please provide the response as plain text only, with no markdown or HTML formatting.`;
                    } else if (lowerCasePrompt.includes('tell me more')) {
                         finalPrompt = `You are an expert magazine guide. The user wants to "tell me more" about the content on this magazine page. 
                         Your task is to provide a comprehensive and detailed answer. The length should be **no more than twice the amount of text on the spread or 500 words, whichever is greater.**
                         Do not just summarize or repeat the text from the page. Instead, synthesize the information on the page with your own broad knowledge to provide a richer, more detailed explanation. Add interesting facts, historical context, or related information that would be helpful to the reader.
                         Important: Do not start your response with phrases like "The magazine page provides a fascinating overview". Get straight to the point.
                         Please provide the response as plain text only, with no markdown or HTML formatting.`;
                    } else {
                        finalPrompt = `You are an expert magazine guide. The user has asked the following question about the attached magazine page: "${prompt}". 
                        Your task is to provide a comprehensive answer. Do not just summarize or repeat the text from the page. Instead, synthesize the information on the page with your own broad knowledge to provide a richer, more detailed explanation. Add interesting facts, historical context, or related information that would be helpful to the reader.
                        Important: Do not start your response with phrases like "The magazine page provides a fascinating overview" or any similar introductory sentence. Get straight to the point.
                        Please provide the response as plain text only, with no markdown or HTML formatting.`;
                    }
                    
                    const payload = { 
                        contents: [{ 
                            parts: [
                                { text: finalPrompt },
                                { inlineData: { mimeType: imageData.mimeType, data: imageData.base64 } }
                            ] 
                        }] 
                    };
                    const apiKey = "curl "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent" \
  -H 'Content-Type: application/json' \
  -H 'X-goog-api-key: GEMINI_API_KEY' \
  -X POST \
  -d '{
    "contents": [
      {
        "parts": [
          {
            "text": "Explain how AI works in a few words"
          }
        ]
      }
    ]
  }'"; // API key will be injected by the environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:streamGenerateContent?alt=sse&key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API error! status: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let firstChunk = true;

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        if (firstChunk) {
                            aiLoader.style.display = 'none';
                            firstChunk = false;
                        }

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();

                        for (const line of lines) {
                            if (line.trim().startsWith('data:')) {
                                const jsonString = line.substring(5).trim();
                                try {
                                    const result = JSON.parse(jsonString);
                                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                                        const textChunk = result.candidates[0].content.parts[0].text;
                                        // Use innerHTML to append so the initial bold tag is preserved
                                        aiResponseText.innerHTML += textChunk.replace(/\n/g, '<br>');
                                    }
                                } catch (e) {
                                    console.warn('Could not parse JSON chunk:', jsonString);
                                }
                            }
                        }
                    }

                } catch (error) {
                    console.error('Error getting answer from Gemini API:', error);
                    aiResponseText.innerText = 'An error occurred while trying to get an answer. Please check the console for details.';
                } finally {
                    aiLoader.style.display = 'none';
                    aiSubmitBtn.disabled = false;
                    summarizeBtn.disabled = false;
                    moreBtn.disabled = false;
                }
            }

            // --- Event Listeners ---
            prevBtn.addEventListener('click', () => {
                if (currentSpread > 0) {
                    currentSpread--;
                    displaySpread();
                }
            });

            nextBtn.addEventListener('click', () => {
                if (currentSpread < totalSpreads - 1) {
                    currentSpread++;
                    displaySpread();
                }
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') prevBtn.click();
                else if (e.key === 'ArrowRight') nextBtn.click();
                else if (e.key === 'Escape' && !aiModal.classList.contains('pointer-events-none')) {
                    closeModalBtn.click();
                }
            });
            
            aiAskBtn.addEventListener('click', () => {
                // Reset modal state
                aiPromptInput.placeholder = "Ask about a specific topic...";
                aiPromptInput.value = '';
                aiResponseText.innerText = '';
                
                // Show modal
                aiModal.classList.remove('opacity-0', 'pointer-events-none');
                aiModal.querySelector('.modal-content').classList.remove('-translate-y-10');
            });

            closeModalBtn.addEventListener('click', () => {
                aiModal.classList.add('opacity-0', 'pointer-events-none');
                aiModal.querySelector('.modal-content').classList.add('-translate-y-10');
            });

            summarizeBtn.addEventListener('click', () => {
                 const targetImage = pageImages[currentSpread * 2 + 1] || pageImages[currentSpread * 2];
                 getAnswer('Summarize this page', targetImage);
                 aiPromptInput.value = '';
            });

            moreBtn.addEventListener('click', () => {
                 const targetImage = pageImages[currentSpread * 2 + 1] || pageImages[currentSpread * 2];
                 getAnswer('Tell me more', targetImage);
                 aiPromptInput.value = '';
            });

            aiSubmitBtn.addEventListener('click', () => {
                const prompt = aiPromptInput.value.trim();
                if (prompt) {
                    const targetImage = pageImages[currentSpread * 2 + 1] || pageImages[currentSpread * 2];
                    getAnswer(prompt, targetImage);
                    aiPromptInput.value = '';
                }
            });
            
            aiPromptInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    aiSubmitBtn.click();
                }
            });
            
            // Initial setup
            displaySpread();
        });
    </script>

</body>
</html>
